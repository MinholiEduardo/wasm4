use crate::wasm4::*;

fn note_to_freq(note_id: i32) -> u32 {
    if note_id < 0 {
        return 0;
    }
    let midi = note_id + 11;
    let freq = 440.0 * f64::powf(2.0, (midi - 69) as f64 / 12.0);
    freq.round() as u32
}

// === Megalovania ===
// Melodia no canal 1 (Pulse 1)
static MELODY: &[i32] = &[
51, 51, 63, -1, 58, -1, -1, 57, -1, 56, -1, 54, -1, 51, 54, 56,
49, 49, 63, -1, 58, -1, -1, 57, -1, 56, -1, 54, -1, 51, 54, 56,
48, 48, 63, -1, 58, -1, -1, 57, -1, 56, -1, 54, -1, 51, 54, 56,
47, 47, 63, -1, 58, -1, -1, 57, -1, 56, -1, 54, -1, 51, 54, 56,
54, -1, 54, 54, -1, 54, -1, 54, -1, 51, -1, 51, -1, -1, -1, -1,
54, -1, 54, 54, -1, 56, -1, 57, -1, 56, 54, 51, 54, 56, -1, -1,
54, -1, 54, 54, -1, 56, -1, 57, -1, 58, -1, 61, -1, 58, -1, -1,
63, -1, 63, -1, 63, 58, 63, 61, -1, -1, -1, -1, 75, -1, -1, -1,
70, -1, 70, 70, -1, 70, -1, 70, -1, 68, -1, 68, -1, -1, -1, -1,
70, -1, 70, -1, 70, 70, -1, 68, -1, 70, -1, 75, -1, 70, 68, -1,
75, -1, 70, -1, 68, -1, 66, -1, 73, -1, 68, -1, 66, -1, 65, -1,
59, -1, 63, 65, -1, 66, -1, 75, -1, -1, -1, -1, -1, -1, -1, -1,
-1,
];

// Harmonia no canal 2 (Pulse 2)
static HARMONY: &[i32] = &[
39, 39, -1, -1, 39, 39, -1, 39, -1, 39, -1, 39, -1, 39, 39, 39,
37, 37, -1, -1, 37, 37, -1, 37, -1, 37, -1, 37, -1, 37, 37, 37,
36, 36, -1, -1, 36, 36, -1, 36, -1, 36, -1, 36, -1, 36, 36, 36,
35, 35, -1, -1, 35, 35, -1, 37, -1, 37, -1, 37, -1, 37, 37, 37,
39, 39, -1, -1, 39, 39, -1, 39, -1, 39, -1, 39, -1, 39, 39, 39,
37, 37, -1, -1, 37, 37, -1, 37, -1, 37, -1, 37, -1, 37, 37, 37,
36, 36, -1, -1, 36, 36, -1, 36, -1, 36, -1, 36, -1, 36, 36, 36,
35, 35, -1, -1, 35, 35, -1, 37, -1, 37, -1, 37, -1, 37, 37, 37,
39, 39, 51, -1, 46, -1, -1, 45, -1, 44, -1, 42, -1, 39, 42, 44,
37, 37, 51, -1, 46, -1, -1, 45, -1, 44, -1, 42, -1, 39, 42, 44,
36, 36, 51, -1, 46, -1, -1, 45, -1, 44, -1, 42, -1, 39, 42, 44,
35, 35, 51, -1, 46, -1, -1, 45, -1, 44, -1, 42, -1, 39, 42, 44,
-1,
];

static mut IDX1: usize = 0;
static mut TIMER1: u32 = 0;
static mut IDX2: usize = 0;
static mut TIMER2: u32 = 0;

pub fn update_music() {
    unsafe {
        // Canal 1 - Melodia
        if IDX1 < MELODY.len() {
            if TIMER1 == 0 {
                let n = &MELODY[IDX1];
                if *n >= 0 {
                    let freq = note_to_freq(*n);
                    tone(freq, 10, 50, TONE_PULSE2);
                }
                TIMER1 = 7;
                IDX1 += 1;
            } else {
                TIMER1 -= 1;
            }
        }

        // Canal 2 - Harmonia
        if IDX2 < HARMONY.len() {
            if TIMER2 == 0 {
                let n = &HARMONY[IDX2];
                if *n >= 0 {
                    let freq = note_to_freq(*n);
                    tone(freq, 10, 50, TONE_PULSE1);
                }
                TIMER2 = 7;
                IDX2 += 1;
            } else {
                TIMER2 -= 1;
            }
        }

        // Reinicia a mÃºsica
        if IDX1 >= MELODY.len() && IDX2 >= HARMONY.len() {
            IDX1 = 0;
            TIMER1 = 0;
            IDX2 = 0;
            TIMER2 = 0;
        }
    }
}